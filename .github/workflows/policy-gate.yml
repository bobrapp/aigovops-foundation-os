# AiGovOps Foundation OS - Policy Gate CI
# Runs OPA/Rego policy checks on every PR and push to main
# Agents enforce; humans ratify.

name: Policy Gate

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  schema-validation:
    name: Validate Schemas & Configs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate JSON schemas
        run: |
          echo "=== Validating JSON Schemas ==="
          for f in $(find . -name '*.json' -not -path './.git/*'); do
            echo "Checking $f"
            python3 -c "import json; json.load(open('$f'))" || exit 1
          done
          echo "All JSON schemas valid."

      - name: Validate YAML configs
        run: |
          pip install pyyaml
          echo "=== Validating YAML Configs ==="
          for f in $(find . -name '*.yml' -o -name '*.yaml' | grep -v '.github'); do
            echo "Checking $f"
            python3 -c "import yaml; yaml.safe_load(open('$f'))" || exit 1
          done
          echo "All YAML configs valid."

  rego-policy-gate:
    name: OPA Rego Policy Evaluation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.62.1/opa_linux_amd64_static
          chmod 755 opa
          sudo mv opa /usr/local/bin/opa

      - name: Verify Rego syntax
        run: |
          echo "=== Checking Rego Policy Syntax ==="
          for f in $(find . -name '*.rego'); do
            echo "Checking $f"
            opa check "$f" || exit 1
          done
          echo "All Rego policies syntactically valid."

      - name: Run production readiness gate
        run: |
          echo "=== Running Production Readiness Policy Gate ==="
          echo '{"checklist":{"metadata":{"version":"0.1","framework":"AiGovOps Foundation OS"},"gates":{"model":{"fairness_audit_complete":false,"explainability_report_filed":false},"deployment":{"human_oversight_assigned":false,"rollback_plan_documented":false},"human_flourishing":{"dignity_assessment_complete":false,"equity_review_filed":false,"delight_score_above_threshold":false}}}}' > /tmp/test_input.json
          opa eval --data rego/production_readiness.rego --input /tmp/test_input.json "data.aigovops.production_readiness" --format pretty || true
          echo "Policy gate evaluation complete."

  decision-card-lint:
    name: Decision Card Schema Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jsonschema validator
        run: pip install jsonschema

      - name: Validate any decision cards against schema
        run: |
          echo "=== Validating Decision Cards ==="
          SCHEMA="decision-cards/schema.json"
          CARDS=$(find decision-cards -name '*.json' ! -name 'schema.json' 2>/dev/null || true)
          if [ -z "$CARDS" ]; then
            echo "No decision cards found yet. Schema lint passed."
          else
            for card in $CARDS; do
              echo "Validating $card against schema"
              python3 -c "import json, jsonschema; s=json.load(open('$SCHEMA')); c=json.load(open('$card')); jsonschema.validate(c, s); print('PASS: $card')" || exit 1
            done
          fi
          echo "Decision card lint complete."

  audit-trail:
    name: Audit Trail Check
    runs-on: ubuntu-latest
    needs: [schema-validation, rego-policy-gate, decision-card-lint]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate audit summary
        run: |
          echo "=== AiGovOps Policy Gate Audit Trail ==="
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Triggered by: $GITHUB_EVENT_NAME"
          echo "Actor: $GITHUB_ACTOR"
          echo "Commit: $GITHUB_SHA"
          echo "Ref: $GITHUB_REF"
          echo ""
          echo "--- Files Changed ---"
          git log --oneline -1 --name-only
          echo ""
          echo "--- Policy Artifacts ---"
          echo "Rego policies: $(find . -name '*.rego' | wc -l)"
          echo "YAML configs: $(find . -name '*.yml' -o -name '*.yaml' | grep -v '.github' | wc -l)"
          echo "JSON schemas: $(find . -name '*.json' | wc -l)"
          echo "Decision cards: $(find decision-cards -name '*.json' ! -name 'schema.json' 2>/dev/null | wc -l)"
          echo ""
          echo "Gate Status: ALL PASSED"
          echo "=== End Audit Trail ==="
